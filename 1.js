let customNodeData = [
  {
    afterFormData: {
      '95e64762a667281a824fa06e': [
        {
          id: '357901356159209472',
          name: '中国铁路成都局集团有限公司重庆供电段',
        },
      ],
      bd1f4818bc34d29ca4af8671: [
        {
          _id: 'sellinf_create',
          label: '新建',
          status: 'ENABLE',
        },
      ],
      d8af4086aae32396e85e3a7d: 'BU202209143554',
      b8254a0296efcb3804bd1920: '2022-10-22',
      ca1a4a5d8efbab37ad9b28de: [
        {
          id: '357903776738185216',
          name: '京东国铁商城',
        },
      ],
      VIRTUAL_DOC_ID: '371599891576655872',
      afb2463e8097c3d48a1f95df: null,
      c575446a81510a4b72cd5ed7: [
        {
          id: '101308716362526621696',
          leafNodeFlag: false,
          structureCode:
            '101308716316854845440·101308716319237210112·101308716334496088064·101308716362526621696',
          structureName: '十月稻田·营销中心·电商业务群·京东业务部',
          name: '京东业务部',
          parentId: '101308716334496088064',
          departmentCode: '638700156',
        },
      ],
      '09ee4aa5959e0f7390559ff7': '京东国铁商城',
      e9fc48ffaac0d127cf44d5ca: 'complete',
      e3fa41f3882071011b69edf6: [
        {
          id: '357903776738185216',
          name: '京东国铁商城',
        },
      ],
      '1c564e08acca737928d7d6ce': 'XSQD0057',
      '0a03417cafe8288b130d2ea4': ['N'],
      '05e646a48b553244de497a3a': 'N',
      '3b9643ad9248917cf6a967f7': [
        {
          _id: 'sales_promotion',
          label: '促销',
          status: 'ENABLE',
        },
      ],
      afa541b49fc109096a0a09a3: {
        province: {
          code: '',
          name: '',
        },
        city: {
          code: '',
          name: '',
        },
        area: {},
        address: {
          name: '',
        },
      },
      '26b9477b84062a3bd1dd1895': '',
      e4e34e029dc2fa79a436fca4: 'KHBM202209140064',
      e4fe419bb4b1064f58546542: [
        {
          id: '308914574189400064',
          name: '五常市彩桥米业有限公司',
        },
      ],
      '9aef48ca8a1777474b64aac3': [
        {
          _id: 'business_classification',
          label: '业务分类',
          status: 'ENABLE',
        },
      ],
      '747c41928be21c03e87dfa4f': '京东线下客户',
    },
    afterTableData: {
      cf974dceb5dc8e6dddce0702: [
        {
          '55464b059953513c0c691bcb': '110104622357',
          b6e64dbf8aa608648286ed82: '柴火大院香稻贡米（大米）5kg',
          '8cea401aa838e804a5dd67ec': '6971599052357',
          TABLE_LOGO:
            'cf974dceb5dc8e6dddce0702-PART-75666f9b-5be5-4eaf-af37-b11d1afcc362',
          '671a459292efefc232a91c0e': '5',
          f18a48a982dfcf6248ed29c4: '袋',
          VIRTUAL_DOC_ID: '371599710911205376',
          '9258411fbf72702450bc220b': 1,
          '40344a7b93c4dc421fd0f664': '2022-10-22',
          '0a03417cafe8288b130d2ea4': [
            {
              _id: 'Y',
              checked: false,
              label: '是',
              status: 'ENABLE',
            },
          ],
          '05e646a48b553244de497a3a': 'N',
          _XID: 'row_137',
          afa541b49fc109096a0a09a3: {
            province: {
              code: '',
              name: '',
            },
            city: {
              code: '',
              name: '',
            },
            area: {},
            address: {
              name: '',
            },
          },
        },
        {
          '55464b059953513c0c691bcb': '110104622357',
          b6e64dbf8aa608648286ed82: '柴火大院香稻贡米（大米）5kg',
          '8cea401aa838e804a5dd67ec': '6971599052357',
          TABLE_LOGO:
            'cf974dceb5dc8e6dddce0702-PART-1f4a4bff-d81f-44b6-af3c-790d5f157196',
          '671a459292efefc232a91c0e': '5',
          f18a48a982dfcf6248ed29c4: '袋',
          VIRTUAL_DOC_ID: '371599891576655872',
          '9258411fbf72702450bc220b': 1,
          '40344a7b93c4dc421fd0f664': '2022-10-22',
          '0a03417cafe8288b130d2ea4': [
            {
              _id: 'Y',
              checked: false,
              label: '是',
              status: 'ENABLE',
            },
          ],
          '05e646a48b553244de497a3a': 'N',
          _XID: 'row_209',
          afa541b49fc109096a0a09a3: {
            province: {
              code: '1200000000',
              name: '天津市',
            },
            city: {
              code: '1201000000',
              name: '天津市',
            },
            area: {
              code: '',
              name: '',
            },
            address: {
              name: '',
            },
          },
        },
        {
          '55464b059953513c0c691bcb': '110104622357',
          b6e64dbf8aa608648286ed82: '柴火大院香稻贡米（大米）5kg',
          '8cea401aa838e804a5dd67ec': '6971599052357',
          TABLE_LOGO:
            'cf974dceb5dc8e6dddce0702-PART-83ce810b-c817-419c-90af-b8c11815010c',
          '671a459292efefc232a91c0e': '5',
          f18a48a982dfcf6248ed29c4: '袋',
          VIRTUAL_DOC_ID: '371599735993143296',
          '9258411fbf72702450bc220b': 1,
          '40344a7b93c4dc421fd0f664': '2022-10-22',
          '0a03417cafe8288b130d2ea4': [
            {
              _id: 'Y',
              checked: false,
              label: '是',
              status: 'ENABLE',
            },
          ],
          '05e646a48b553244de497a3a': 'N',
          _XID: 'row_185',
          afa541b49fc109096a0a09a3: {
            province: {
              code: '1300000000',
              name: '河北省',
            },
            city: {
              code: '1306000000',
              name: '保定市',
            },
            area: {
              code: '',
              name: '',
            },
            address: {
              name: '',
            },
          },
        },
        // {
        //   '55464b059953513c0c691bcb': '110104622357',
        //   b6e64dbf8aa608648286ed82: '柴火大院香稻贡米（大米）5kg',
        //   '8cea401aa838e804a5dd67ec': '6971599052357',
        //   TABLE_LOGO:
        //     'cf974dceb5dc8e6dddce0702-PART-cbfbce8e-5b99-4af7-8352-6845d54da6bb',
        //   '671a459292efefc232a91c0e': '5',
        //   f18a48a982dfcf6248ed29c4: '袋',
        //   VIRTUAL_DOC_ID: '371599715181006848',
        //   '9258411fbf72702450bc220b': 1,
        //   '40344a7b93c4dc421fd0f664': '2022-10-22',
        //   '0a03417cafe8288b130d2ea4': [
        //     {
        //       _id: 'Y',
        //       checked: false,
        //       label: '是',
        //       status: 'ENABLE',
        //     },
        //   ],
        //   '05e646a48b553244de497a3a': 'N',
        //   _XID: 'row_138',
        //   afa541b49fc109096a0a09a3: {
        //     province: {
        //       code: '1300000000',
        //       name: '河北省',
        //     },
        //     city: {
        //       code: '',
        //       name: '',
        //     },
        //     area: {
        //       code: '',
        //       name: '',
        //     },
        //     address: {
        //       name: '',
        //     },
        //   },
        // },
      ],
    },
    currentTableDataFlag: false,
  },
]

// let customNodeData = lowCodeContext.businessEventEngine.customNodeData

// 获取到子表的数据
let table = customNodeData[0].afterTableData['cf974dceb5dc8e6dddce0702']

let flag = {
  isPass: false, // 是否通过校验
  addressText: '', // 未通过地址校验的提示语
  DateText: '', // 未通过日期校验的提示语
}

// 比较时间区间  返回为 true则存在交集
function compareTimeUnion(oneStart, oneEnd, twoStart, twoEnd) {
  let flag = false

  if (oneStart && twoStart) {
    let args = Array.prototype.slice.call(arguments)
    const newArgs = []

    args.forEach((item) => {
      newArgs.push(
        item ? new Date(item).getTime() : new Date('2099-12-31').getTime()
      )
    })
    // 开始时间，在第二个时间的时间段中
    // 结束时间，在第二个时间的时间段中
    if (
      (newArgs[0] >= newArgs[2] && newArgs[0] <= newArgs[3]) ||
      (newArgs[1] >= newArgs[2] && newArgs[1] <= newArgs[3]) ||
      (newArgs[0] <= newArgs[2] && newArgs[1] >= newArgs[3])
    ) {
      flag = true
    }
  }

  return flag
}

// 返回错误信息
function errorMessage(table, index) {
  return `${table[index]['55464b059953513c0c691bcb']}物料 ${jointArea(
    table[index]['afa541b49fc109096a0a09a3']
  )} 的组合存在多条记录，并且生效日期交叉，请调整生效日期范围`
}

// 拼接地址信息
function jointArea(areaObj) {
  if (!areaObj) {
    return
  }

  let address = ''
  if (areaObj.province && areaObj.province.name) {
    address += areaObj.province.name
  }
  if (
    areaObj.province &&
    areaObj.province.name &&
    areaObj.city &&
    areaObj.city.name
  ) {
    address += '-' + areaObj.city.name
  }
  if (
    areaObj.province &&
    areaObj.province.name &&
    areaObj.city &&
    areaObj.city.name &&
    areaObj.area &&
    areaObj.area.name
  ) {
    address += '-' + areaObj.area.name
  }

  return address ? address + '地区' : address
}

// 比较地址
function compareAddress(oneObj, twoObj) {
  let flag = false

  // 1. 都存在省
  if (
    oneObj.province &&
    twoObj.province &&
    oneObj.province.code &&
    twoObj.province.code
  ) {
    // 1.1 市编码相同-需要比较
    if (
      oneObj.city &&
      twoObj.city &&
      oneObj.city.code &&
      twoObj.city.code &&
      oneObj.city.code === twoObj.city.code
    ) {
      flag = true
    }

    // 1.2 都不存在市
    if (
      !oneObj.city &&
      !twoObj.city &&
      oneObj.province.code === twoObj.province.code
    ) {
      flag = true
    }
  }

  // 2. 都不存在省，也要比较
  if (!twoObj.province.code && !oneObj.province.code) {
    flag = true
  }

  return flag
}

// 编码相同才校验 - 地址都为空或者地址相同的校验 - 校验日期是否有交集
for (let i = 0; i < table.length; i++) {
  // goodKeys
  const goodKeys = '55464b059953513c0c691bcb' // 商品编码
  const address = 'afa541b49fc109096a0a09a3' // 地址字段
  const startTime = '40344a7b93c4dc421fd0f664' // 开始时间
  const endTime = 'a1a24418b0e8eaad0953fc89' // 结束时间

  const ele = table[i]

  for (let j = i + 1; j < table.length; j++) {
    const item = table[j]

    // 1. 商品编码相同？
    if (ele[goodKeys] === item[goodKeys]) {
      // 2. 一个存在省 一个不存在省，也要比较
      if (
        (!ele[address].province.code && item[address].province.code) ||
        (ele[address].province.code && !item[address].province.code)
      ) {
        flag.isPass = true
        flag.addressText = errorMessage(table, i)
        break
      }

      // 对比地址
      if (compareAddress(ele[address], item[address])) {
        // 3. 校验日期
        if (
          compareTimeUnion(
            ele[startTime],
            ele[endTime],
            item[startTime],
            item[endTime]
          )
        ) {
          flag.isPass = true
          flag.addressText = errorMessage(table, i)
          break
        }
      }
    }
  }

  if (flag.isPass) break
}

console.log(flag)
return flag
